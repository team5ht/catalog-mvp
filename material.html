<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Материал</title>
<link rel="stylesheet" href="styles/tokens.css" />
<link rel="stylesheet" href="styles/base.css" />
<link rel="stylesheet" href="styles/components/buttons.css" />
<link rel="stylesheet" href="styles/components/navigation.css" />
<link rel="stylesheet" href="styles/pages/material.css" />
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#f1f5f9">
</head>
<body class="material-page-body">
<main class="material-page">
  <!-- Кнопка назад -->
  <button class="material-page__back-button" onclick="history.back()" aria-label="Назад">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
      <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>

  <!-- Обложка материала -->
  <div class="material-page__cover-wrapper">
    <div id="materialCover" class="material-page__cover"></div>
  </div>

  <!-- Кнопка действия -->
  <button id="downloadBtn" class="button button--download is-loading" type="button">Скачать</button>

  <!-- Контент -->
  <div class="material-page__content">
    <h1 id="materialTitle" class="material-page__title">Загрузка...</h1>

    <section class="material-page__section">
      <h2 class="material-page__section-title">О материале</h2>
      <p id="materialDescription" class="material-page__description"></p>
    </section>

    <section class="material-page__section">
      <h2 class="material-page__section-title">Теги</h2>
      <div id="materialTags" class="material-page__tags"></div>
    </section>
  </div>
</main>

<nav class="bottom-nav">
  <button id="nav-home" class="bottom-nav__button" aria-label="Главная">
    <svg class="bottom-nav__icon" width="25" height="25" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M3 12l9-9 9 9v9a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3v-9z" fill="none" stroke-width="2"/></svg>
  </button>
  <button id="nav-catalog" class="bottom-nav__button" aria-label="Каталог">
    <svg class="bottom-nav__icon" width="25" height="25" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><rect x="3" y="4" width="18" height="16" fill="none" stroke-width="2"/></svg>
  </button>
  <button id="nav-account" class="bottom-nav__button nav-account is-loading" aria-label="Профиль">
    <!-- Иконка вставляется скриптом -->
  </button>
</nav>

<script src="auth-state.js"></script>
<script src="app.js"></script>
<script src="nav-auth.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const navHome = document.getElementById('nav-home');
  const navCatalog = document.getElementById('nav-catalog');
  if (navHome) {
    navHome.onclick = () => location.href = 'index.html';
  }
  if (navCatalog) {
    navCatalog.onclick = () => location.href = 'catalog.html';
  }

  // Получаем ID материала из URL
  const urlParams = new URLSearchParams(window.location.search);
  const materialId = parseInt(urlParams.get('id'));

  if (!materialId) {
    location.href = 'index.html';
    return;
  }

  const AUTH_STORAGE_KEY = 'auth_logged_in';

  function getAuthModule() {
    return typeof window !== 'undefined' ? window.AuthState : null;
  }

  function isUserAuthenticated() {
    const authModule = getAuthModule();
    if (authModule && typeof authModule.isAuthenticated === 'function') {
      return authModule.isAuthenticated();
    }
    return false;
  }

  function renderDownloadButtonState(button) {
    if (!button) {
      return;
    }

    const authed = isUserAuthenticated();
    button.textContent = authed ? 'Скачать' : 'Войти и скачать';
    button.setAttribute('aria-label', authed ? 'Скачать материал' : 'Войти и скачать материал');
    button.classList.toggle('button--download--authed', authed);
    button.classList.toggle('button--download--guest', !authed);
    button.classList.remove('is-loading');
  }

  const downloadBtn = document.getElementById('downloadBtn');
  renderDownloadButtonState(downloadBtn);

  window.addEventListener('storage', (event) => {
    if (event.key === AUTH_STORAGE_KEY) {
      renderDownloadButtonState(downloadBtn);
    }
  });

  window.addEventListener('authstatechange', () => {
    renderDownloadButtonState(downloadBtn);
  });

  // Загружаем данные и отображаем материал
  fetch('data.json')
    .then(r => r.json())
    .then(data => {
      const material = data.materials.find(m => m.id === materialId);
      if (!material) {
        location.href = 'index.html';
        return;
      }

      // Обложка
      document.getElementById('materialCover').style.backgroundImage = `url(${material.cover})`;

      // Название
      document.getElementById('materialTitle').textContent = material.title;

      // Описание
      document.getElementById('materialDescription').textContent = material.description;

      // Теги
      const tagsContainer = document.getElementById('materialTags');
      if (material.tags && material.tags.length > 0) {
        material.tags.forEach(tag => {
          const tagEl = document.createElement('span');
          tagEl.className = 'material-page__tag chip chip--tag';
          tagEl.textContent = tag;
          tagsContainer.appendChild(tagEl);
        });
      } else {
        tagsContainer.innerHTML = '<span class="material-page__tag chip chip--tag">Без тегов</span>';
      }

      // Кнопка скачать
      if (downloadBtn) {
        downloadBtn.onclick = () => {
          const authed = isUserAuthenticated();
          if (!authed) {
            const currentUrl = window.location.href;
            if (window.AuthState && typeof window.AuthState.setRedirectUrl === 'function') {
              window.AuthState.setRedirectUrl(currentUrl);
            }
            const loginUrl = `auth-login.html?redirect=${encodeURIComponent(currentUrl)}`;
            window.location.href = loginUrl;
            return;
          }

          if (material.pdfUrl) {
            window.open(material.pdfUrl, '_blank');
          } else {
            alert('Ссылка на материал недоступна');
          }
        };
      }
    });
});
</script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('sw.js');
  });
}
</script>
</body>
</html>
