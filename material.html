<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Материал</title>
<link rel="stylesheet" href="styles/tokens.css" />
<link rel="stylesheet" href="styles/ui.css" />
<link rel="stylesheet" href="styles/pages.css" />
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffffff">
</head>
<body class="app-shell">
<main class="material-page app-container">
  <!-- Кнопка назад -->
  <button class="material-page__back-button" aria-label="Назад">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
      <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>

  <!-- Обложка материала -->
  <div class="material-page__cover-wrapper">
    <div id="materialCover" class="material-page__cover"></div>
  </div>

  <!-- Кнопка действия -->
  <div class="material-download">
    <button id="downloadBtn" class="button button--secondary button--download is-loading" type="button">Скачать</button>
  </div>

  <!-- Контент -->
  <div class="material-page__content">
    <h1 id="materialTitle" class="material-page__title page-title">Загрузка...</h1>

    <section class="material-page__section section">
      <h2 class="material-page__section-title section-title">О материале</h2>
      <p id="materialDescription" class="material-page__description text-body"></p>
    </section>

    <section class="material-page__section section">
      <h2 class="material-page__section-title section-title">Теги</h2>
      <div id="materialTags" class="material-page__tags"></div>
    </section>
  </div>
</main>

<nav class="bottom-nav">
  <button id="nav-home" class="bottom-nav__button" aria-label="Главная">
    <svg class="bottom-nav__icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
      <use href="assets/icons/sprite.svg#icon-main"></use>
    </svg>
  </button>
  <button id="nav-catalog" class="bottom-nav__button" aria-label="Каталог">
    <svg class="bottom-nav__icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
      <use href="assets/icons/sprite.svg#icon-catalog"></use>
    </svg>
  </button>
  <button id="nav-account" class="bottom-nav__button nav-account is-loading" aria-label="Профиль">
    <svg class="bottom-nav__icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
      <use href="assets/icons/sprite.svg#icon-unauthorised"></use>
    </svg>
  </button>
</nav>

<script src="supabase-config.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="supabase-client.js"></script>
<script src="app.js"></script>
<script src="nav-auth.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const navHome = document.getElementById('nav-home');
  const navCatalog = document.getElementById('nav-catalog');
  if (navHome) {
    navHome.onclick = () => location.href = 'index.html';
  }
  if (navCatalog) {
    navCatalog.onclick = () => location.href = 'catalog.html';
  }

  // Получаем ID материала из URL
  const urlParams = new URLSearchParams(window.location.search);
  const materialId = parseInt(urlParams.get('id'));

  if (!materialId) {
    location.href = 'index.html';
    return;
  }

  const backButton = document.querySelector('.material-page__back-button');
  const BACK_URL_DEFAULTS = ['catalog.html', 'index.html'];
  const AUTH_PAGES = ['auth-login.html'];
  const STORAGE_KEY = `materialBackUrl:${materialId}`;

  function isAuthPage(url) {
    try {
      const parsed = new URL(url, window.location.origin);
      const path = parsed.pathname;
      return AUTH_PAGES.some(page => path.endsWith(`/${page}`) || path.endsWith(page));
    } catch (err) {
      return false;
    }
  }

  function deriveBackUrlFromReferrer() {
    if (!document.referrer) {
      return null;
    }
    try {
      const refUrl = new URL(document.referrer);
      const sameOrigin = refUrl.origin === window.location.origin;
      if (!sameOrigin || isAuthPage(refUrl.href)) {
        return null;
      }
      return refUrl.href;
    } catch (err) {
      return null;
    }
  }

  function getFallbackBackUrl() {
    return BACK_URL_DEFAULTS[0] || '/';
  }

  function resolveBackUrl() {
    const referrerBack = deriveBackUrlFromReferrer();

    if (referrerBack) {
      sessionStorage.setItem(STORAGE_KEY, referrerBack);
      return referrerBack;
    }

    const stored = sessionStorage.getItem(STORAGE_KEY);
    if (stored) {
      return stored;
    }

    const fallback = getFallbackBackUrl();
    sessionStorage.setItem(STORAGE_KEY, fallback);
    return fallback;
  }

  const resolvedBackUrl = resolveBackUrl();

  if (backButton) {
    backButton.addEventListener('click', (event) => {
      event.preventDefault();
      window.location.href = resolvedBackUrl;
    });
  }

  let currentSession = null;

  function getClient() {
    return typeof window !== 'undefined' ? window.supabaseClient : null;
  }

  async function refreshSession() {
    const client = getClient();
    if (!client || !client.auth || typeof client.auth.getSession !== 'function') {
      currentSession = null;
      return currentSession;
    }
    try {
      const { data } = await client.auth.getSession();
      currentSession = data ? data.session : null;
    } catch (err) {
      console.warn('Не удалось получить сессию Supabase', err);
      currentSession = null;
    }
    return currentSession;
  }

  function isUserAuthenticated() {
    return Boolean(currentSession && currentSession.user);
  }

  function showMaterialError(message) {
    const titleEl = document.getElementById('materialTitle');
    const descEl = document.getElementById('materialDescription');
    if (titleEl) titleEl.textContent = message;
    if (descEl) descEl.textContent = 'Попробуйте обновить страницу позже.';
    if (downloadBtn) {
      downloadBtn.textContent = 'Недоступно';
      downloadBtn.disabled = true;
      downloadBtn.classList.remove('button--primary', 'button--secondary');
    }
  }

  function renderDownloadButtonState(button) {
    if (!button) {
      return;
    }

    const authed = isUserAuthenticated();
    button.textContent = authed ? 'Скачать' : 'Войти и скачать';
    button.setAttribute('aria-label', authed ? 'Скачать материал' : 'Войти и скачать материал');
    button.classList.toggle('button--primary', authed);
    button.classList.toggle('button--secondary', !authed);
    button.classList.remove('is-loading');
  }

  const downloadBtn = document.getElementById('downloadBtn');
  refreshSession().then(() => renderDownloadButtonState(downloadBtn));

  const client = getClient();
  if (client && client.auth && typeof client.auth.onAuthStateChange === 'function') {
    client.auth.onAuthStateChange((_event, session) => {
      currentSession = session;
      renderDownloadButtonState(downloadBtn);
    });
  }

  // Загружаем данные и отображаем материал
  loadAppData()
    .then((data) => {
      if (!data || !Array.isArray(data.materials)) {
        throw new Error('Invalid data.json format');
      }
      const material = data.materials.find(m => m.id === materialId);
      if (!material) {
        location.href = 'index.html';
        return;
      }

      // Обложка
      document.getElementById('materialCover').style.backgroundImage = `url(${material.cover})`;

      // Название
      document.getElementById('materialTitle').textContent = material.title;

      // Описание
      document.getElementById('materialDescription').textContent = material.description;

      // Теги
      const tagsContainer = document.getElementById('materialTags');
      if (material.tags && material.tags.length > 0) {
        material.tags.forEach(tag => {
          const tagEl = document.createElement('span');
          tagEl.className = 'material-page__tag chip chip--tag';
          tagEl.textContent = tag;
          tagsContainer.appendChild(tagEl);
        });
      } else {
        tagsContainer.innerHTML = '<span class="material-page__tag chip chip--tag">Без тегов</span>';
      }

      // Кнопка скачать
      if (downloadBtn) {
        downloadBtn.onclick = () => {
          const authed = isUserAuthenticated();
          if (!authed) {
            const currentUrl = window.location.href;
            const loginUrl = `auth-login.html?redirect=${encodeURIComponent(currentUrl)}`;
            window.location.href = loginUrl;
            return;
          }

          if (material.pdfUrl) {
            window.open(material.pdfUrl, '_blank');
          } else {
            alert('Ссылка на материал недоступна');
          }
        };
      }
    })
    .catch(() => {
      showMaterialError('Не удалось загрузить материал.');
    });
});
</script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('sw.js');
  });
}
</script>
</body>
</html>
