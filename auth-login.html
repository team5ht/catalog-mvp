<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Вход в 5HT</title>
  <link rel="stylesheet" href="styles/tokens.css" />
  <link rel="stylesheet" href="styles/base.css" />
  <link rel="stylesheet" href="styles/components/buttons.css" />
  <link rel="stylesheet" href="styles/pages/login.css" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#ffffff" />
  <script src="supabase-config.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="supabase-client.js"></script>
</head>
<body>
  <div class="auth-page">
    <form class="auth-form" id="authLoginForm" novalidate>
      <h1 class="auth-form__title">Вход или регистрация</h1>
      <p class="auth-form__subtitle">
        Используйте email и пароль, чтобы войти или создать аккаунт.
      </p>
      <input
        type="email"
        id="authEmail"
        class="auth-form__input"
        placeholder="name@example.com"
        required
        autocomplete="email"
        inputmode="email"
        aria-label="Email"
      />
      <input
        type="password"
        id="authPassword"
        class="auth-form__input"
        placeholder="Пароль (мин. 6 символов)"
        required
        autocomplete="current-password"
        aria-label="Пароль"
      />
      <p id="authError" class="auth-form__note" role="alert" aria-live="polite" style="color:var(--color-danger);display:none;"></p>
      <button type="submit" class="button button--primary" data-action="login">Войти</button>
      <button type="submit" class="button button--secondary" data-action="signup" style="margin-top:0.75rem;">Зарегистрироваться</button>
      <p class="auth-form__note">
        Пароль должен содержать минимум 6 символов.
        После регистрации мы отправим письмо для подтверждения.
        После подтверждения зайдите с паролем через форму входа.
      </p>
    </form>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('authLoginForm');
      const emailInput = document.getElementById('authEmail');
      const passwordInput = document.getElementById('authPassword');
      const errorEl = document.getElementById('authError');
      const params = new URLSearchParams(window.location.search);
      const supabaseClient = window.supabaseClient;
      let submitAction = 'login';

      function getRedirectTarget() {
        const redirectParam = params.get('redirect');
        if (!redirectParam) {
          return 'index.html';
        }
        try {
          const targetUrl = new URL(redirectParam, window.location.origin);
          if (targetUrl.origin !== window.location.origin) {
            return 'index.html';
          }
          const path = `${targetUrl.pathname}${targetUrl.search}${targetUrl.hash}`;
          return path || 'index.html';
        } catch (_err) {
          return redirectParam.startsWith('/') ? redirectParam : 'index.html';
        }
      }

      function setError(message) {
        if (!errorEl) return;
        if (message) {
          errorEl.textContent = message;
          errorEl.style.display = 'block';
        } else {
          errorEl.textContent = '';
          errorEl.style.display = 'none';
        }
      }

      function setLoading(isLoading) {
        if (!form) return;
        const buttons = form.querySelectorAll('button[data-action]');
        buttons.forEach((btn) => {
          btn.disabled = isLoading;
        });
        if (emailInput) emailInput.disabled = isLoading;
        if (passwordInput) passwordInput.disabled = isLoading;
      }

      async function handleAuth(action) {
        setError('');
        if (!supabaseClient || !supabaseClient.auth) {
          setError('Не удалось подключиться к сервису авторизации. Попробуйте позже.');
          return;
        }

        const email = (emailInput.value || '').trim();
        const password = passwordInput.value || '';
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        if (!email || !emailPattern.test(email)) {
          setError('Введите корректный email.');
          return;
        }

        if (!password || password.length < 6) {
          setError('Минимум 6 символов в пароле.');
          return;
        }

        setLoading(true);
        try {
          if (action === 'signup') {
            const { error } = await supabaseClient.auth.signUp({ email, password });

            if (error) {
              const code = error.code || '';
              const message = (error.message || '').toLowerCase();
              if (code === 'user_already_exists' || message.includes('user already registered') || message.includes('user already exists')) {
                setError('Этот email уже зарегистрирован. Попробуйте войти или восстановить пароль.');
              } else {
                setError('Не удалось зарегистрироваться. Попробуйте ещё раз или чуть позже.');
              }
              return;
            }

            setError('Мы отправили письмо для подтверждения. После подтверждения вернитесь и войдите с паролем.');
            return;
          }

          const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
          if (error) {
            setError('Не удалось войти. Проверьте email и пароль и попробуйте ещё раз.');
            return;
          }

          window.location.href = getRedirectTarget();
        } catch (err) {
          console.warn('Ошибка авторизации', err);
          setError('Что-то пошло не так. Попробуйте ещё раз.');
        } finally {
          setLoading(false);
        }
      }

      form.addEventListener('click', (event) => {
        const actionBtn = event.target.closest('button[data-action]');
        if (actionBtn && actionBtn.dataset.action) {
          submitAction = actionBtn.dataset.action;
        }
      });

      form.addEventListener('submit', (event) => {
        event.preventDefault();
        handleAuth(submitAction);
      });
    });
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js');
      });
    }
  </script>
</body>
</html>
