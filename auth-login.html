<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Вход в 5HT</title>
  <link rel="stylesheet" href="styles/tokens.css" />
  <link rel="stylesheet" href="styles/base.css" />
  <link rel="stylesheet" href="styles/components/buttons.css" />
  <link rel="stylesheet" href="styles/pages/login.css" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#f8fafc" />
  <script src="supabase-config.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="supabase-client.js"></script>
  <script src="auth-state.js"></script>
</head>
<body>
  <div class="auth-page">
    <form class="auth-form" id="authLoginForm" novalidate>
      <h1 class="auth-form__title">Вход или регистрация</h1>
      <p class="auth-form__subtitle">Используйте email и пароль, чтобы войти или создать аккаунт.</p>
      <input
        type="email"
        id="authEmail"
        class="auth-form__input"
        placeholder="name@example.com"
        required
        autocomplete="email"
        inputmode="email"
        aria-label="Email"
      />
      <input
        type="password"
        id="authPassword"
        class="auth-form__input"
        placeholder="Пароль (мин. 6 символов)"
        required
        autocomplete="current-password"
        aria-label="Пароль"
      />
      <p id="authError" class="auth-form__note" role="alert" aria-live="polite" style="color:#b91c1c;display:none;"></p>
      <button type="submit" class="button button--primary" data-action="login">Войти</button>
      <button type="submit" class="button button--secondary" data-action="signup" style="margin-top:0.75rem;">Зарегистрироваться</button>
      <p class="auth-form__note">Пароль должен содержать минимум 6 символов. После успешного входа мы вернём вас на предыдущую страницу.</p>
    </form>

    <div class="auth-form" id="authSessionBlock" hidden>
      <h2 class="auth-form__title">Вы уже вошли</h2>
      <p id="authUserInfo" class="auth-form__paragraph"></p>
      <button type="button" class="button button--primary" id="authContinueButton">Продолжить</button>
      <button type="button" class="button button--secondary" id="authLogoutButton" style="margin-top:0.75rem;">Выйти</button>
    </div>

    <div class="auth-form" id="authDebugPanel" aria-live="polite" style="margin-top:1.5rem;">
      <h2 class="auth-form__title">Дебаг регистрации/логина</h2>
      <p class="auth-form__note">Выводим ключевые проверки, чтобы понять, почему не создаётся пользователь или не приходит письмо.</p>
      <div id="authDebugLog" style="background:#0f172a; color:#e2e8f0; padding:0.75rem; border-radius:0.75rem; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:0.9rem; max-height:240px; overflow:auto;">Загружаем дебаг...</div>
      <button type="button" class="button button--secondary" id="authDebugClear" style="margin-top:0.75rem;">Очистить лог</button>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('authLoginForm');
      const emailInput = document.getElementById('authEmail');
      const passwordInput = document.getElementById('authPassword');
      const errorEl = document.getElementById('authError');
      const sessionBlock = document.getElementById('authSessionBlock');
      const userInfoEl = document.getElementById('authUserInfo');
      const logoutBtn = document.getElementById('authLogoutButton');
      const continueBtn = document.getElementById('authContinueButton');
      const debugLogEl = document.getElementById('authDebugLog');
      const debugClearBtn = document.getElementById('authDebugClear');
      const params = new URLSearchParams(window.location.search);
      const supabaseClient = window.supabaseClient;
      let submitAction = 'login';

      const presetEmail = params.get('email');
      if (presetEmail && emailInput) {
        emailInput.value = presetEmail;
      }

      function getRedirectTarget() {
        const redirectParam = params.get('redirect');
        const redirectFromStorage = window.AuthState && typeof window.AuthState.getRedirectUrl === 'function'
          ? window.AuthState.getRedirectUrl()
          : null;
        return redirectParam || redirectFromStorage || 'index.html';
      }

      function setError(message) {
        if (!errorEl) return;
        if (message) {
          errorEl.textContent = message;
          errorEl.style.display = 'block';
        } else {
          errorEl.textContent = '';
          errorEl.style.display = 'none';
        }
      }

      function setLoading(isLoading) {
        const buttons = form ? form.querySelectorAll('button[data-action]') : [];
        buttons.forEach(btn => {
          btn.disabled = isLoading;
        });
        if (emailInput) emailInput.disabled = isLoading;
        if (passwordInput) passwordInput.disabled = isLoading;
      }

      function renderSession(user) {
        const authed = Boolean(user);
        if (sessionBlock) sessionBlock.hidden = !authed;
        if (form) form.style.display = authed ? 'none' : 'block';
        if (userInfoEl) {
          userInfoEl.textContent = authed
            ? `Вы вошли как ${user.email || 'пользователь'}.`
            : 'Вы не авторизованы.';
        }
      }

      function maskValue(value) {
        if (!value) return 'не задано';
        const str = String(value);
        if (str.length <= 6) return `${str[0]}***${str[str.length - 1]}`;
        return `${str.slice(0, 3)}***${str.slice(-3)}`;
      }

      function appendDebug(message, details) {
        if (!debugLogEl) return;
        const entry = document.createElement('div');
        const time = new Date().toLocaleTimeString();
        const detailText = details === undefined ? '' : ` | ${typeof details === 'string' ? details : JSON.stringify(details)}`;
        entry.textContent = `[${time}] ${message}${detailText}`;
        debugLogEl.appendChild(entry);
        debugLogEl.scrollTop = debugLogEl.scrollHeight;
      }

      if (debugClearBtn) {
        debugClearBtn.addEventListener('click', () => {
          if (debugLogEl) {
            debugLogEl.textContent = 'Лог очищен';
          }
        });
      }

      async function syncSession() {
        if (window.AuthState && typeof window.AuthState.refreshSession === 'function') {
          return window.AuthState.refreshSession();
        }
        if (supabaseClient && supabaseClient.auth && typeof supabaseClient.auth.getSession === 'function') {
          const { data } = await supabaseClient.auth.getSession();
          return data ? data.session : null;
        }
        return null;
      }

      function getCurrentUser() {
        if (window.AuthState && typeof window.AuthState.getUser === 'function') {
          return window.AuthState.getUser();
        }
        return null;
      }

      async function handleAuth(action) {
        setError('');
        appendDebug('Запуск обработки действия', { action });
        if (!supabaseClient || !supabaseClient.auth) {
          setError('Не удалось подключиться к сервису авторизации. Попробуйте позже.');
          appendDebug('Нет клиента Supabase, регистрация/логин невозможны');
          return;
        }

        const email = (emailInput.value || '').trim();
        const password = passwordInput.value || '';
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        if (!email || !emailPattern.test(email)) {
          emailInput.setCustomValidity('Введите корректный email');
          emailInput.reportValidity();
          appendDebug('Валидация email не пройдена', { email });
          return;
        }

        if (!password || password.length < 6) {
          passwordInput.setCustomValidity('Минимум 6 символов в пароле');
          passwordInput.reportValidity();
          appendDebug('Пароль короче 6 символов');
          return;
        }

        emailInput.setCustomValidity('');
        passwordInput.setCustomValidity('');

        setLoading(true);
        try {
          appendDebug('Отправляем запрос в Supabase', { action, email });
          const { data, error } = action === 'signup'
            ? await supabaseClient.auth.signUp({ email, password })
            : await supabaseClient.auth.signInWithPassword({ email, password });

          appendDebug('Ответ Supabase получен', {
            action,
            hasUser: Boolean(data && data.user),
            hasSession: Boolean(data && data.session),
            error: error ? { message: error.message, status: error.status, name: error.name } : null,
          });

          if (error) {
            setError(action === 'signup'
              ? 'Не удалось зарегистрироваться. Попробуйте снова.'
              : 'Не удалось войти. Проверьте данные и попробуйте ещё раз.');
            appendDebug('Supabase вернул ошибку', { message: error.message, status: error.status, name: error.name });
            return;
          }

          const session = (data && data.session) ? data.session : await syncSession();
          const user = (session && session.user) || getCurrentUser();

          appendDebug('Результат после попытки получить сессию', {
            session: Boolean(session),
            user: Boolean(user),
            email: user && user.email,
          });

          if (!user && action === 'signup') {
            setError('Мы отправили письмо для подтверждения. После подтверждения войдите с паролем.');
            renderSession(null);
            appendDebug('Пользователь не вернулся сразу после регистрации (возможно, включено подтверждение email)');
            return;
          }

          if (!user) {
            setError('Не удалось получить сессию. Попробуйте снова.');
            renderSession(null);
            appendDebug('Сессия не получена даже после логина');
            return;
          }

          renderSession(user);
          appendDebug('Успешно, перенаправляем пользователя', { redirect: getRedirectTarget(), email: user.email });
          window.location.href = getRedirectTarget();
        } catch (err) {
          console.warn('Ошибка авторизации', err);
          setError('Что-то пошло не так. Попробуйте ещё раз.');
          appendDebug('Исключение во время авторизации', { message: err && err.message });
        } finally {
          setLoading(false);
        }
      }

      form.addEventListener('click', (event) => {
        const actionBtn = event.target.closest('button[data-action]');
        if (actionBtn && actionBtn.dataset.action) {
          submitAction = actionBtn.dataset.action;
        }
      });

      form.addEventListener('submit', (event) => {
        event.preventDefault();
        handleAuth(submitAction);
      });

      if (logoutBtn) {
        logoutBtn.addEventListener('click', async (event) => {
          event.preventDefault();
          try {
            if (supabaseClient && supabaseClient.auth && typeof supabaseClient.auth.signOut === 'function') {
              await supabaseClient.auth.signOut();
            }
          } catch (err) {
            console.warn('Ошибка при выходе из Supabase', err);
          }
          await syncSession();
          renderSession(getCurrentUser());
        });
      }

      if (continueBtn) {
        continueBtn.addEventListener('click', () => {
          window.location.href = getRedirectTarget();
        });
      }

      syncSession().then((session) => {
        const user = session && session.user ? session.user : getCurrentUser();
        renderSession(user);
        appendDebug('Инициализация завершена, сессия синхронизирована', { hasSession: Boolean(session), email: user && user.email });
      });

      window.addEventListener('authstatechange', (event) => {
        const user = event && event.detail ? event.detail.user : getCurrentUser();
        renderSession(user);
        appendDebug('Получено событие authstatechange', { email: user && user.email });
      });

      (function runStartupDebugChecks() {
        appendDebug('Стартуем дебаг регистрации/логина');
        appendDebug('Supabase URL', maskValue(window.SUPABASE_URL));
        appendDebug('Supabase ключ', maskValue(window.SUPABASE_PUBLISHABLE_KEY));
        appendDebug('Supabase SDK доступен', typeof window.supabase === 'object' && typeof window.supabase.createClient === 'function');
        appendDebug('Supabase клиент создан', Boolean(supabaseClient));
        appendDebug('Поддержка методов auth', {
          signUp: Boolean(supabaseClient && supabaseClient.auth && supabaseClient.auth.signUp),
          signInWithPassword: Boolean(supabaseClient && supabaseClient.auth && supabaseClient.auth.signInWithPassword),
          signOut: Boolean(supabaseClient && supabaseClient.auth && supabaseClient.auth.signOut),
        });

        const supabaseUrl = window.SUPABASE_URL || '';
        if (supabaseUrl) {
          const healthUrl = `${supabaseUrl.replace(/\/$/, '')}/auth/v1/health`;
          fetch(healthUrl)
            .then((res) => {
              appendDebug('Проверка доступности Supabase /auth/v1/health', { status: res.status, ok: res.ok });
              if (!res.ok) {
                appendDebug('Supabase отвечает ошибкой, письмо может не отправляться');
              }
            })
            .catch((err) => {
              appendDebug('Ошибка сети при обращении к Supabase', { message: err && err.message });
            });
        } else {
          appendDebug('Supabase URL не задан, запросы не будут уходить');
        }
      })();
    });
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js');
      });
    }
  </script>
</body>
</html>
