<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Вход в 5HT</title>
  <link rel="stylesheet" href="styles/tokens.css" />
  <link rel="stylesheet" href="styles/base.css" />
  <link rel="stylesheet" href="styles/components/buttons.css" />
  <link rel="stylesheet" href="styles/pages/login.css" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#f8fafc" />
  <script src="supabase-config.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="supabase-client.js"></script>
  <script src="auth-state.js"></script>
</head>
<body>
  <div class="auth-page">
    <form class="auth-form" id="authLoginForm" novalidate>
      <h1 class="auth-form__title">Вход или регистрация</h1>
      <p class="auth-form__subtitle">Используйте email и пароль, чтобы войти или создать аккаунт.</p>
      <input
        type="email"
        id="authEmail"
        class="auth-form__input"
        placeholder="name@example.com"
        required
        autocomplete="email"
        inputmode="email"
        aria-label="Email"
      />
      <input
        type="password"
        id="authPassword"
        class="auth-form__input"
        placeholder="Пароль (мин. 6 символов)"
        required
        autocomplete="current-password"
        aria-label="Пароль"
      />
      <p id="authError" class="auth-form__note" role="alert" aria-live="polite" style="color:#b91c1c;display:none;"></p>
      <button type="submit" class="button button--primary" data-action="login">Войти</button>
      <button type="submit" class="button button--secondary" data-action="signup" style="margin-top:0.75rem;">Зарегистрироваться</button>
      <p class="auth-form__note">Пароль должен содержать минимум 6 символов. После успешного входа мы вернём вас на предыдущую страницу.</p>
    </form>

    <div class="auth-form" id="authSessionBlock" hidden>
      <h2 class="auth-form__title">Вы уже вошли</h2>
      <p id="authUserInfo" class="auth-form__paragraph"></p>
      <button type="button" class="button button--primary" id="authContinueButton">Продолжить</button>
      <button type="button" class="button button--secondary" id="authLogoutButton" style="margin-top:0.75rem;">Выйти</button>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('authLoginForm');
      const emailInput = document.getElementById('authEmail');
      const passwordInput = document.getElementById('authPassword');
      const errorEl = document.getElementById('authError');
      const sessionBlock = document.getElementById('authSessionBlock');
      const userInfoEl = document.getElementById('authUserInfo');
      const logoutBtn = document.getElementById('authLogoutButton');
      const continueBtn = document.getElementById('authContinueButton');
      const params = new URLSearchParams(window.location.search);
      const supabaseClient = window.supabaseClient;
      let submitAction = 'login';

      const presetEmail = params.get('email');
      if (presetEmail && emailInput) {
        emailInput.value = presetEmail;
      }

      function getRedirectTarget() {
        const redirectParam = params.get('redirect');
        const redirectFromStorage = window.AuthState && typeof window.AuthState.getRedirectUrl === 'function'
          ? window.AuthState.getRedirectUrl()
          : null;
        return redirectParam || redirectFromStorage || 'index.html';
      }

      function setError(message) {
        if (!errorEl) return;
        if (message) {
          errorEl.textContent = message;
          errorEl.style.display = 'block';
        } else {
          errorEl.textContent = '';
          errorEl.style.display = 'none';
        }
      }

      function setLoading(isLoading) {
        const buttons = form ? form.querySelectorAll('button[data-action]') : [];
        buttons.forEach(btn => {
          btn.disabled = isLoading;
        });
        if (emailInput) emailInput.disabled = isLoading;
        if (passwordInput) passwordInput.disabled = isLoading;
      }

      function renderSession(user) {
        const authed = Boolean(user);
        if (sessionBlock) sessionBlock.hidden = !authed;
        if (form) form.style.display = authed ? 'none' : 'block';
        if (userInfoEl) {
          userInfoEl.textContent = authed
            ? `Вы вошли как ${user.email || 'пользователь'}.`
            : 'Вы не авторизованы.';
        }
      }

      async function syncSession() {
        if (supabaseClient && supabaseClient.auth && typeof supabaseClient.auth.getSession === 'function') {
          const { data } = await supabaseClient.auth.getSession();
          return data ? data.session : null;
        }
        return null;
      }

      async function handleAuth(action) {
        setError('');
        if (!supabaseClient || !supabaseClient.auth) {
          setError('Не удалось подключиться к сервису авторизации. Попробуйте позже.');
          return;
        }

        const email = (emailInput.value || '').trim();
        const password = passwordInput.value || '';
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        if (!email || !emailPattern.test(email)) {
          emailInput.setCustomValidity('Введите корректный email');
          emailInput.reportValidity();
          return;
        }

        if (!password || password.length < 6) {
          passwordInput.setCustomValidity('Минимум 6 символов в пароле');
          passwordInput.reportValidity();
          return;
        }

        emailInput.setCustomValidity('');
        passwordInput.setCustomValidity('');

        setLoading(true);
        try {
          const { data, error } = action === 'signup'
            ? await supabaseClient.auth.signUp({ email, password })
            : await supabaseClient.auth.signInWithPassword({ email, password });

          if (error) {
            setError(action === 'signup'
              ? 'Не удалось зарегистрироваться. Возможно, email уже используется или письмо не может быть отправлено. Попробуйте войти или воспользуйтесь восстановлением пароля.'
              : 'Не удалось войти. Проверьте данные и попробуйте ещё раз.');
            return;
          }

          const session = (data && data.session) ? data.session : await syncSession();
          const user = session ? session.user : null;

          if (!user && action === 'signup') {
            setError('Мы отправили письмо для подтверждения. После подтверждения войдите с паролем.');
            renderSession(null);
            return;
          }

          if (!user) {
            setError('Не удалось получить сессию. Попробуйте снова.');
            renderSession(null);
            return;
          }

          renderSession(user);
          window.location.href = getRedirectTarget();
        } catch (err) {
          console.warn('Ошибка авторизации', err);
          setError('Что-то пошло не так. Попробуйте ещё раз.');
        } finally {
          setLoading(false);
        }
      }

      form.addEventListener('click', (event) => {
        const actionBtn = event.target.closest('button[data-action]');
        if (actionBtn && actionBtn.dataset.action) {
          submitAction = actionBtn.dataset.action;
        }
      });

      form.addEventListener('submit', (event) => {
        event.preventDefault();
        handleAuth(submitAction);
      });

      if (logoutBtn) {
        logoutBtn.addEventListener('click', async (event) => {
          event.preventDefault();
          try {
            if (supabaseClient && supabaseClient.auth && typeof supabaseClient.auth.signOut === 'function') {
              await supabaseClient.auth.signOut();
            }
          } catch (err) {
            console.warn('Ошибка при выходе из Supabase', err);
          }
          const session = await syncSession();
          renderSession(session ? session.user : null);
        });
      }

      if (continueBtn) {
        continueBtn.addEventListener('click', () => {
          window.location.href = getRedirectTarget();
        });
      }

      syncSession().then((session) => {
        renderSession(session ? session.user : null);
      });
    });
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js');
      });
    }
  </script>
</body>
</html>
