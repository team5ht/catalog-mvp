<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('authLoginForm');
    const emailInput = document.getElementById('authEmail');
    const passwordInput = document.getElementById('authPassword');
    const errorEl = document.getElementById('authError');
    const sessionBlock = document.getElementById('authSessionBlock');
    const userInfoEl = document.getElementById('authUserInfo');
    const logoutBtn = document.getElementById('authLogoutButton');
    const continueBtn = document.getElementById('authContinueButton');
    const params = new URLSearchParams(window.location.search);
    const supabaseClient = window.supabaseClient;
    let submitAction = 'login';

    // === DEBUG ПАНЕЛЬ ДЛЯ iPHONE ===
    const debugBox = document.createElement('pre');
    debugBox.id = 'authDebug';
    debugBox.style.fontSize = '10px';
    debugBox.style.whiteSpace = 'pre-wrap';
    debugBox.style.background = '#fee2e2';
    debugBox.style.color = '#111827';
    debugBox.style.padding = '8px';
    debugBox.style.margin = '12px auto';
    debugBox.style.maxWidth = '420px';
    debugBox.style.borderRadius = '8px';
    debugBox.textContent = 'DEBUG LOG:\n';
    document.body.appendChild(debugBox);

    function debug(label, data) {
      if (!debugBox) return;
      const line =
        '\n[' +
        new Date().toISOString() +
        '] ' +
        label +
        ':\n' +
        JSON.stringify(data, null, 2) +
        '\n';
      debugBox.textContent += line;
    }

    // Логируем стартовую конфигурацию
    debug('initial_config', {
      SUPABASE_URL: window.SUPABASE_URL,
      hasPublishableKey: !!window.SUPABASE_PUBLISHABLE_KEY,
      hasSupabaseClient: !!supabaseClient
    });

    const presetEmail = params.get('email');
    if (presetEmail && emailInput) {
      emailInput.value = presetEmail;
    }

    function getRedirectTarget() {
      const redirectParam = params.get('redirect');
      const redirectFromStorage =
        window.AuthState && typeof window.AuthState.getRedirectUrl === 'function'
          ? window.AuthState.getRedirectUrl()
          : null;
      return redirectParam || redirectFromStorage || 'index.html';
    }

    function setError(message) {
      if (!errorEl) return;
      if (message) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
      } else {
        errorEl.textContent = '';
        errorEl.style.display = 'none';
      }
      debug('setError', { message });
    }

    function setLoading(isLoading) {
      const buttons = form ? form.querySelectorAll('button[data-action]') : [];
      buttons.forEach((btn) => {
        btn.disabled = isLoading;
      });
      if (emailInput) emailInput.disabled = isLoading;
      if (passwordInput) passwordInput.disabled = isLoading;
      debug('setLoading', { isLoading });
    }

    function renderSession(user) {
      const authed = Boolean(user);
      if (sessionBlock) sessionBlock.hidden = !authed;
      if (form) form.style.display = authed ? 'none' : 'block';
      if (userInfoEl) {
        userInfoEl.textContent = authed
          ? `Вы вошли как ${user.email || 'пользователь'}.`
          : 'Вы не авторизованы.';
      }
      debug('renderSession', {
        authed,
        userEmail: user && user.email ? user.email : null
      });
    }

    async function syncSession() {
      debug('syncSession_start', {});
      try {
        if (window.AuthState && typeof window.AuthState.refreshSession === 'function') {
          const session = await window.AuthState.refreshSession();
          debug('syncSession_AuthState', { session });
          return session;
        }
        if (supabaseClient && supabaseClient.auth && typeof supabaseClient.auth.getSession === 'function') {
          const { data, error } = await supabaseClient.auth.getSession();
          debug('syncSession_supabase', { data, errorMessage: error && error.message });
          return data ? data.session : null;
        }
      } catch (err) {
        debug('syncSession_error', { message: err.message, stack: String(err.stack || '') });
      }
      return null;
    }

    function getCurrentUser() {
      if (window.AuthState && typeof window.AuthState.getUser === 'function') {
        const user = window.AuthState.getUser();
        debug('getCurrentUser_AuthState', { user });
        return user;
      }
      debug('getCurrentUser_none', {});
      return null;
    }

    async function handleAuth(action) {
      setError('');
      debug('handleAuth_start', { action });

      if (!supabaseClient || !supabaseClient.auth) {
        setError('Не удалось подключиться к сервису авторизации. Попробуйте позже.');
        debug('handleAuth_noClient', {});
        return;
      }

      const email = (emailInput.value || '').trim();
      const password = passwordInput.value || '';
      const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      if (!email || !emailPattern.test(email)) {
        emailInput.setCustomValidity('Введите корректный email');
        emailInput.reportValidity();
        debug('handleAuth_invalidEmail', { email });
        return;
      }

      if (!password || password.length < 6) {
        passwordInput.setCustomValidity('Минимум 6 символов в пароле');
        passwordInput.reportValidity();
        debug('handleAuth_invalidPassword', { length: password.length });
        return;
      }

      emailInput.setCustomValidity('');
      passwordInput.setCustomValidity('');

      setLoading(true);
      try {
        let result;
        if (action === 'signup') {
          result = await supabaseClient.auth.signUp({ email, password });
        } else {
          result = await supabaseClient.auth.signInWithPassword({ email, password });
        }

        const { data, error } = result || {};
        debug('auth_result', {
          action,
          data,
          errorMessage: error && error.message,
          error
        });

        if (error) {
          setError(
            action === 'signup'
              ? 'Не удалось зарегистрироваться. Попробуйте снова.'
              : 'Не удалось войти. Проверьте данные и попробуйте ещё раз.'
          );
          return;
        }

        const session = data && data.session ? data.session : await syncSession();
        const user = (session && session.user) || getCurrentUser();

        debug('auth_session_user', { session, user });

        if (!user && action === 'signup') {
          setError('Мы отправили письмо для подтверждения. После подтверждения войдите с паролем.');
          renderSession(null);
          return;
        }

        if (!user) {
          setError('Не удалось получить сессию. Попробуйте снова.');
          renderSession(null);
          return;
        }

        renderSession(user);
        const target = getRedirectTarget();
        debug('auth_redirect', { target });
        window.location.href = target;
      } catch (err) {
        debug('handleAuth_exception', { message: err.message, stack: String(err.stack || '') });
        console.warn('Ошибка авторизации', err);
        setError('Что-то пошло не так. Попробуйте ещё раз.');
      } finally {
        setLoading(false);
      }
    }

    // Отслеживаем, по какой кнопке кликнули
    form.addEventListener('click', (event) => {
      const actionBtn = event.target.closest('button[data-action]');
      if (actionBtn && actionBtn.dataset.action) {
        submitAction = actionBtn.dataset.action;
        debug('click_action', { submitAction });
      }
    });

    form.addEventListener('submit', (event) => {
      event.preventDefault();
      debug('form_submit', { submitAction });
      handleAuth(submitAction);
    });

    if (logoutBtn) {
      logoutBtn.addEventListener('click', async (event) => {
        event.preventDefault();
        debug('logout_click', {});
        try {
          if (
            supabaseClient &&
            supabaseClient.auth &&
            typeof supabaseClient.auth.signOut === 'function'
          ) {
            await supabaseClient.auth.signOut();
          }
        } catch (err) {
          debug('logout_error', { message: err.message, stack: String(err.stack || '') });
          console.warn('Ошибка при выходе из Supabase', err);
        }
        const session = await syncSession();
        const user = session && session.user ? session.user : getCurrentUser();
        renderSession(user);
      });
    }

    if (continueBtn) {
      continueBtn.addEventListener('click', () => {
        const target = getRedirectTarget();
        debug('continue_click', { target });
        window.location.href = target;
      });
    }

    // Первичная синхронизация сессии
    syncSession().then((session) => {
      const user = session && session.user ? session.user : getCurrentUser();
      debug('initial_syncSession_done', { session, user });
      renderSession(user);
    });

    // Реакция на события AuthState
    window.addEventListener('authstatechange', (event) => {
      const user = event && event.detail ? event.detail.user : getCurrentUser();
      debug('authstatechange_event', { eventDetail: event && event.detail, user });
      renderSession(user);
    });
  });
</script>