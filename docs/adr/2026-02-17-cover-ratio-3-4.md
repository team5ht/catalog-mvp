# ADR: Переход обложек материалов с `2:3` на `3:4`

- Date: 2026-02-17
- Status: Accepted
- Supersedes (partially): `docs/adr/2026-02-16-image-pipeline-refactor.md` (только часть про ratio обложек и image runtime cache version)
- Scope: cover image ratio в UI, pipeline, валидации и SW runtime image cache
- Policy: `behavior-change`

## Контекст

После внедрения semantic image pipeline обложки материалов рендерились в ratio `2:3`.
Для текущего визуального направления каталога требуется менее вытянутый формат `3:4`
при сохранении текущих ширин карточек и контейнеров.

Требования:

- изменить ratio единообразно в build/runtime/CSS;
- исключить риск, что в репозиторий попадут старые generated-файлы `2:3`;
- инвалидировать runtime image cache после релиза изменения.

## Решение

1. Cover ratio в image pipeline изменен на `3:4`.

- `scripts/images/config.mjs`: `COVER_RATIO = { width: 3, height: 4 }`
- ширины cover остаются прежними: `160/240/320/480w`

2. Runtime presets и контейнеры UI переведены на `3:4`.

- `scripts/app/ui/responsive-image.js`: `coverCarousel`, `coverCatalog`, `coverDetail`
- `styles/ui.css`: `.material-card__cover`, `.catalog-card__cover`
- `styles/pages.css`: `.material-page__cover`
- fallback без `aspect-ratio`: `padding-top: 133.3333%`

3. `images:check` усилен проверкой геометрии generated-файлов через `sharp.metadata()`.

- cover ожидает размеры:
  - `160x213`
  - `240x320`
  - `320x427`
  - `480x640`
- hero остается без изменений (`8:3`)
- проверка размеров добавлена поверх существующих проверок наличия файлов и budget-лимитов

4. Runtime image cache version в Service Worker повышен до `catalog-mvp-images-v17`.

## Последствия

- Публичные API и schema `data.json` не меняются.
- Меняется контракт generated cover geometry: было `2:3`, стало `3:4`.
- После изменения обязателен `npm run images:build`, иначе `npm run images:check` падает на несоответствии размеров.
- Клиенты, у которых был закеширован старый runtime image cache, получают новые cover-ассеты после обновления SW.

## Тестирование и приемка

- `npm run images:build`
- `npm run images:check`
- `npm run test:e2e`
- smoke e2e дополнены проверками:
  - `img[width="480"][height="640"]` для всех cover-представлений;
  - ratio контейнеров обложек `~0.75` (`3:4`);
  - отсутствие inline `background-image` для контентных обложек.

## Риски

- Пропуск rebuild generated-файлов перед коммитом.
- Неполная синхронизация ratio между CSS/runtime/pipeline.

Снижение риска обеспечивается автоматическими проверками в `images:check` и smoke e2e.
