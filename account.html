<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Личный кабинет</title>
<link rel="stylesheet" href="styles/tokens.css" />
<link rel="stylesheet" href="styles/tokens.theme-linear.css" />
<link rel="stylesheet" href="styles/base.css" />
<link rel="stylesheet" href="styles/components/buttons.css" />
<link rel="stylesheet" href="styles/components/navigation.css" />
<link rel="stylesheet" href="styles/pages/account.css" />
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffffff">
</head>
<body class="app-shell">
<main class="app-container account-page">
  <header class="account-header">
    <p class="account-kicker">Аккаунт</p>
    <h1 class="page-title">Личный кабинет</h1>
    <p class="account-subtitle">Проверьте email и управляйте доступом к материалам.</p>
  </header>

  <section class="card account-card" aria-labelledby="accountEmail">
    <div class="account-identity">
      <div>
        <p class="account-label">Ваш email</p>
        <p id="accountEmail" class="account-email">Загрузка...</p>
      </div>
    </div>

    <div class="account-actions">
      <button id="changePasswordButton" class="btn btn-primary-soft" type="button">Изменить пароль</button>
      <button id="logoutButton" class="btn btn-primary" type="button">Выйти</button>
      <p id="accountError" class="account-error" role="alert" aria-live="polite"></p>
      <p class="account-version">Версия приложения v1</p>
    </div>
  </section>
</main>

<nav class="bottom-nav">
  <button id="nav-home" class="bottom-nav__button" aria-label="Главная">
    <svg class="bottom-nav__icon" width="25" height="25" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M3 12l9-9 9 9v9a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3v-9z" fill="none" stroke-width="2"/></svg>
  </button>
  <button id="nav-catalog" class="bottom-nav__button" aria-label="Каталог">
    <svg class="bottom-nav__icon" width="25" height="25" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><rect x="3" y="4" width="18" height="16" fill="none" stroke-width="2"/></svg>
  </button>
  <button id="nav-account" class="bottom-nav__button bottom-nav__button--active nav-account is-loading" aria-label="Профиль">
    <!-- Иконка вставляется скриптом -->
  </button>
</nav>

<script src="supabase-config.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="supabase-client.js"></script>
<script src="app.js"></script>
<script src="nav-auth.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const emailEl = document.getElementById('accountEmail');
  const errorEl = document.getElementById('accountError');
  const logoutBtn = document.getElementById('logoutButton');
  const changePasswordBtn = document.getElementById('changePasswordButton');
  const client = window.supabaseClient;

  function setError(message) {
    if (!errorEl) return;
    if (message) {
      errorEl.textContent = message;
      errorEl.classList.add('account-error--visible');
    } else {
      errorEl.textContent = '';
      errorEl.classList.remove('account-error--visible');
    }
  }

  function setEmail(email) {
    if (emailEl) {
      emailEl.textContent = email || 'Без email';
    }
  }

  function redirectToLogin(target) {
    const redirectTarget = target || window.location.href;
    const loginUrl = `auth-login.html?redirect=${encodeURIComponent(redirectTarget)}`;
    window.location.href = loginUrl;
  }

  async function fetchSession() {
    if (!client || !client.auth || typeof client.auth.getSession !== 'function') {
      return null;
    }
    try {
      const { data } = await client.auth.getSession();
      return data ? data.session : null;
    } catch (err) {
      console.warn('Не удалось получить сессию Supabase', err);
      return null;
    }
  }

  async function ensureSession() {
    const session = await fetchSession();
    if (!session) {
      redirectToLogin(window.location.href);
      return null;
    }
    setEmail(session.user?.email);
    return session;
  }

  function setupNavLinks() {
    const navHome = document.getElementById('nav-home');
    const navCatalog = document.getElementById('nav-catalog');
    if (navHome) {
      navHome.onclick = () => location.href = 'index.html';
    }
    if (navCatalog) {
      navCatalog.onclick = () => location.href = 'catalog.html';
    }
  }

  setupNavLinks();
  ensureSession();

  if (client && client.auth && typeof client.auth.onAuthStateChange === 'function') {
    client.auth.onAuthStateChange((_event, session) => {
      if (!session) {
        redirectToLogin(window.location.href);
        return;
      }
      setEmail(session.user?.email);
      setError('');
    });
  }

  if (changePasswordBtn) {
    changePasswordBtn.addEventListener('click', () => {
      alert('Функция в разработке');
    });
  }

  if (logoutBtn) {
    logoutBtn.addEventListener('click', async () => {
      setError('');
      if (!client || !client.auth || typeof client.auth.signOut !== 'function') {
        redirectToLogin('index.html');
        return;
      }

      const defaultText = 'Выйти';
      logoutBtn.disabled = true;
      logoutBtn.textContent = 'Выходим...';

      try {
        const { error } = await client.auth.signOut();
        if (error) {
          throw error;
        }
        window.location.href = `auth-login.html?redirect=${encodeURIComponent('index.html')}`;
      } catch (err) {
        console.warn('Ошибка при выходе из Supabase', err);
        logoutBtn.disabled = false;
        logoutBtn.textContent = defaultText;
        setError('Не удалось выйти. Попробуйте ещё раз.');
      }
    });
  }
});
</script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('sw.js');
  });
}
</script>
</body>
</html>
